<!DOCTYPE html>

<html>
<head>
  <title>Tonic Image Builder</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="/tonic-image-builder/css/main.css">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
<header class="site-header">

    <nav class="mobile-nav show-on-mobiles">
        <a class="page-link" href="/tonic-image-builder/"><i class="fa fa-home fa-fw fa-lg"></i></a>
        <a class="page-link" href="/tonic-image-builder/docs/home"><i class="fa fa-book fa-fw fa-lg"></i></a>
        <a class="page-link" href="/tonic-image-builder/news"><i class="fa fa-newspaper-o fa-fw fa-lg"></i></a>
    </nav>
    <div class="wrapper">

        <a class="site-title center-on-mobiles" href="/">
            <img src="/tonic-image-builder/img/logo.png" height="40" alt="Logo">
            Tonic Image Builder
        </a>
        <nav class="site-nav hide-on-mobiles">
            <a href="#" class="menu-icon">
                <svg viewBox="0 0 18 15">
                    <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                    <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                    <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
            </a>
            <div class="trigger">
                <a class="page-link" href="/tonic-image-builder/">Home</a>
                <a class="page-link" href="/tonic-image-builder/docs/home">Docs</a>
                <a class="page-link" href="/tonic-image-builder/news">News</a>
            </div>
        </nav>
    </div>

</header>

  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>colorByHelper.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="colorByHelper.html">
                    colorByHelper.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="cpu-compositor.html">
                    cpu-compositor.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="gpu-compositor.html">
                    gpu-compositor.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="addLayerColor.html">
                    addLayerColor.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="addLitLayerColor.html">
                    addLitLayerColor.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="CompositorFactory.html">
                    CompositorFactory.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="raw-rgbd-compositor.html">
                    raw-rgbd-compositor.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="rgbd-compositor.html">
                    rgbd-compositor.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="background.html">
                    background.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="composite.html">
                    composite.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="compositeLight.html">
                    compositeLight.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="compositeLut.html">
                    compositeLut.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="display.html">
                    display.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sxyz-light-compositor.html">
                    sxyz-light-compositor.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="alphaBlend.html">
                    alphaBlend.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="display.html">
                    display.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="rgbaColor.html">
                    rgbaColor.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sorted-volume-compositor-cpu.html">
                    sorted-volume-compositor-cpu.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="sorted-volume-compositor-gpu.html">
                    sorted-volume-compositor-gpu.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="LookupTable.html">
                    LookupTable.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="LookupTableManager.html">
                    LookupTableManager.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="Presets.html">
                    Presets.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="test-lookuptable.html">
                    test-lookuptable.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="basic.html">
                    basic.c
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-keyword">var</span> encoding = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createColorLookupConst</span>(<span class="hljs-params">lut, value</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idx</span>) </span>{
        <span class="hljs-keyword">return</span> lut.getColor(value);
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createColorLookup</span>(<span class="hljs-params">lut, floatMap, layer, color</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">idx</span>) </span>{
        <span class="hljs-keyword">var</span> value = floatMap[layer][color][idx];
        <span class="hljs-keyword">return</span> lut.getColor(value);
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ColorByHelper</span> </span>{
    constructor(layers, fieldCodes, lookupTableManager) {
        <span class="hljs-keyword">this</span>.nbLayers = layers.length;
        <span class="hljs-keyword">this</span>.fieldCodes = fieldCodes;
        <span class="hljs-keyword">this</span>.lookupTableManager = lookupTableManager;
        <span class="hljs-keyword">this</span>.layerFloatData = {};
        <span class="hljs-keyword">this</span>.layerVisible = {};
        <span class="hljs-keyword">this</span>.layerAlpha = {};
        <span class="hljs-keyword">this</span>.layerColorBy = {};
        <span class="hljs-keyword">this</span>.layerGetColor = {};
        <span class="hljs-keyword">this</span>.categories = [];</pre></div>
        
      
        
        <p>Fill function map to get color</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> layerIdx = <span class="hljs-number">0</span>; layerIdx &lt; <span class="hljs-keyword">this</span>.nbLayers; layerIdx++) {
            <span class="hljs-keyword">this</span>.layerFloatData[encoding[layerIdx]] = {};
            <span class="hljs-keyword">this</span>.layerVisible[encoding[layerIdx]] = <span class="hljs-number">1.0</span>;
            <span class="hljs-keyword">this</span>.layerAlpha[encoding[layerIdx]] = <span class="hljs-number">1.0</span>;
            <span class="hljs-keyword">this</span>.layerGetColor[encoding[layerIdx]] = {};

            <span class="hljs-keyword">var</span> array = layers[layerIdx].colorBy,
                count = array.length;
            <span class="hljs-keyword">while</span>(count--) {
                <span class="hljs-keyword">var</span> colorBy = array[count],
                    layerCode = encoding[layerIdx],
                    colorName = colorBy.name,
                    lut = <span class="hljs-keyword">this</span>.lookupTableManager.getLookupTable(colorBy.name);

                <span class="hljs-keyword">if</span>(colorBy.type === <span class="hljs-string">'const'</span>) {
                    <span class="hljs-keyword">this</span>.layerGetColor[layerCode][colorName] = createColorLookupConst(lut, colorBy.value);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(colorBy.type === <span class="hljs-string">'field'</span>) {
                    <span class="hljs-keyword">this</span>.layerGetColor[layerCode][colorName] = createColorLookup(lut, <span class="hljs-keyword">this</span>.layerFloatData, layerCode, colorName);
                }
            }
        }
    }

    updateData(data) {
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> data) {
            <span class="hljs-keyword">if</span>(name.indexOf(<span class="hljs-string">'_'</span>) !== -<span class="hljs-number">1</span>) {
                <span class="hljs-keyword">var</span> splitName = name.split(<span class="hljs-string">'_'</span>),
                    layerName = encoding[<span class="hljs-built_in">Number</span>(splitName[<span class="hljs-number">0</span>])],
                    colorBy = splitName[<span class="hljs-number">1</span>];

                <span class="hljs-keyword">this</span>.layerFloatData[layerName][colorBy] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Float32Array</span>(data[name].data);
            }
        }
    }

    updatePipeline(query) {
        <span class="hljs-keyword">this</span>.categories = [];
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> layerIdx = <span class="hljs-number">0</span>; layerIdx &lt; <span class="hljs-keyword">this</span>.nbLayers; layerIdx++) {
            <span class="hljs-keyword">var</span> layerCode = encoding[layerIdx],
                colorCode = query[layerIdx*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>];

            <span class="hljs-keyword">if</span>(colorCode === <span class="hljs-string">'_'</span>) {
                <span class="hljs-keyword">this</span>.layerVisible[layerCode] = <span class="hljs-number">0.0</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.layerVisible[layerCode] = <span class="hljs-number">1.0</span>;
                <span class="hljs-keyword">this</span>.layerColorBy[layerCode] = <span class="hljs-keyword">this</span>.fieldCodes[colorCode];
                <span class="hljs-keyword">this</span>.categories.push([layerIdx, <span class="hljs-keyword">this</span>.fieldCodes[colorCode]].join(<span class="hljs-string">'_'</span>));
            }
        }
    }

    updateAlphas(alphas) {
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.nbLayers; i++) {
            <span class="hljs-keyword">this</span>.layerAlpha[encoding[i]] = alphas[i];
        }
    }

    hasNoContent(layerIdx) {
        <span class="hljs-keyword">var</span> layerCode = encoding[layerIdx],
            alpha = <span class="hljs-keyword">this</span>.layerAlpha[layerCode] * <span class="hljs-keyword">this</span>.layerVisible[layerCode];
        <span class="hljs-keyword">return</span> (alpha === <span class="hljs-number">0</span>);
    }

    getColor(layerIdx, pixelIdx) {
        <span class="hljs-keyword">var</span> layerCode = encoding[layerIdx],
            color = <span class="hljs-keyword">this</span>.layerGetColor[layerCode][<span class="hljs-keyword">this</span>.layerColorBy[layerCode]](pixelIdx),
            alpha = <span class="hljs-keyword">this</span>.layerAlpha[layerCode] * <span class="hljs-keyword">this</span>.layerVisible[layerCode];

        <span class="hljs-keyword">return</span> [color[<span class="hljs-number">0</span>] * <span class="hljs-number">255</span>, color[<span class="hljs-number">1</span>] * <span class="hljs-number">255</span>, color[<span class="hljs-number">2</span>] * <span class="hljs-number">255</span>, color[<span class="hljs-number">3</span>] * alpha];
    }

    getCategories() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.categories;
    }

    getLayerColorByName(layerIdx) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.layerColorBy[encoding[layerIdx]];
    }

    getLayerVisible(layerIdx) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.layerVisible[encoding[layerIdx]];
    }

    getLayerLut(layerIdx) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.lookupTableManager.getLookupTable(<span class="hljs-keyword">this</span>.layerColorBy[encoding[layerIdx]]);
    }

    getLayerFloatData(layerIdx) {
        <span class="hljs-keyword">var</span> layerName = encoding[layerIdx];
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.layerFloatData[layerName][<span class="hljs-keyword">this</span>.layerColorBy[layerName]];
    }

    getLayerAlpha(layerIdx) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.layerAlpha[encoding[layerIdx]];
    }
}</pre></div>
        
      
    </div>
  </div>
</body>
</html>
